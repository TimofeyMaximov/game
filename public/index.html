<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Морской бой</title>
  <style>
    body {
      font-family: sans-serif;
      background: #eef;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 { margin-bottom: 10px; }
    #status, #msg {
      margin: 10px;
      font-size: 1.1em;
      font-weight: bold;
    }
    #grid {
      display: grid;
      grid-template-columns: repeat(10, 30px);
      gap: 2px;
    }
    .cell {
      width: 30px;
      height: 30px;
      border: 1px solid #888;
      background: #fff;
      text-align: center;
      line-height: 30px;
      cursor: pointer;
    }
    .ship {
      background: gray !important;
    }
    .hit-mine {
      background: red !important;
      color: white;
    }
    .hit-enemy {
      background: green !important;
      color: white;
    }
    .miss {
      background: lightblue !important;
    }
    .disabled {
      pointer-events: none;
    }
  </style>
</head>
<body>
  <h1>Морской бой</h1>
  <div id="status">Ожидание подключения второго игрока...</div>
  <div id="grid"></div>
  <div id="msg"></div>

  <script>
    const grid = document.getElementById('grid');
    const status = document.getElementById('status');
    const msg = document.getElementById('msg');
    const ws = new WebSocket(location.origin.replace(/^http/, 'ws'));

    let setupDone = false;
    let isMyTurn = false;
    let gameOver = false;
    const board = {};

    function disableGrid() {
      grid.classList.add("disabled");
    }

    function showMsg(text, color = 'green') {
      msg.textContent = text;
      msg.style.color = color;
      setTimeout(() => msg.textContent = '', 2000);
    }

    for (let y = 0; y < 10; y++) {
      for (let x = 0; x < 10; x++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.x = x;
        cell.dataset.y = y;
        grid.appendChild(cell);

        cell.addEventListener('click', () => {
          if (gameOver) return;
          if (!setupDone) {
            if (!cell.classList.contains('ship') && Object.keys(board).length < 10) {
              cell.classList.add('ship');
              board[`${x},${y}`] = true;
              if (Object.keys(board).length === 10) {
                ws.send(JSON.stringify({ type: 'setup', board }));
                setupDone = true;
                status.textContent = 'Ожидание второго игрока...';
              }
            }
          } else if (isMyTurn) {
            if (!cell.classList.contains('hit-enemy') && !cell.classList.contains('miss')) {
              ws.send(JSON.stringify({ type: 'fire', x, y }));
              isMyTurn = false;
              status.textContent = 'Ход соперника...';
            }
          }
        });
      }
    }

    ws.onmessage = ({ data }) => {
      const msgData = JSON.parse(data);
      const x = msgData.x;
      const y = msgData.y;
      const cell = [...grid.children].find(c => c.dataset.x == x && c.dataset.y == y);

      if (msgData.type === 'setup') {
        status.textContent = 'Расставьте 10 кораблей (по клеткам)';
      }

      if (msgData.type === 'start') {
        isMyTurn = msgData.yourTurn;
        status.textContent = isMyTurn ? 'Ваш ход!' : 'Ход соперника...';
      }

      if (msgData.type === 'yourTurn') {
        isMyTurn = true;
        status.textContent = 'Ваш ход!';
      }

      if (msgData.type === 'result') {
        if (msgData.hit) {
          cell.classList.add('hit-enemy');
          showMsg('ПОПАЛ!', 'green');
        } else {
          cell.classList.add('miss');
        }
      }

      if (msgData.type === 'incoming') {
        if (msgData.hit) {
          cell.classList.add('hit-mine');
        } else {
          if (!cell.classList.contains('ship')) {
            cell.classList.add('miss');
          }
        }
      }

      if (msgData.type === 'win') {
        status.textContent = 'Вы выиграли!';
        showMsg('ПОБЕДА!', 'darkgreen');
        gameOver = true;
        disableGrid();
      }

      if (msgData.type === 'lose') {
        status.textContent = 'Вы проиграли!';
        showMsg('Поражение', 'darkred');
        gameOver = true;
        disableGrid();
      }

      if (msgData.type === 'disconnect') {
        status.textContent = 'Соперник отключился.';
        gameOver = true;
        disableGrid();
      }
    };
  </script>
</body>
</html>